services:
  # The Flask Application
  app:
    build: ./app
    container_name: aca_app
    ports:
      - "8080:8080"
    depends_on:
      - cosmos-emulator

  # Dapr sidecar for the app
  app-dapr:
    image: "daprio/daprd:latest"
    command: [
      "./daprd",
      "-app-id", "aca-app",
      "-app-port", "8080",
      "-components-path", "/components"
    ]
    volumes:
      - ./components:/components
    network_mode: "service:app"
    depends_on:
      - app

  # Cosmos DB Emulator
  cosmos-emulator:
    image: mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator
    container_name: cosmos_local
    hostname: cosmos-emulator
    ports:
      - "8081:8081"
      - "1234:1234"
    environment:
      - AZURE_COSMOS_EMULATOR_PARTITION_COUNT=10
      - AZURE_COSMOS_EMULATOR_ENABLE_DATA_EXPLORER=True

  # Dev Container service
  dev:
    image: mcr.microsoft.com/devcontainers/python:1-3.11-bullseye
    volumes:
      - ..:/workspaces/azure-container-apps:cached
    network_mode: service:app
    command: /bin/sh -c "while sleep 1000; do :; done"
