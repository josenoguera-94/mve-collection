# Azure Container Apps + Cosmos DB

Minimal viable example to work with Azure Container Apps and Azure Cosmos DB locally. This example demonstrates how to orchestrate infrastructure with Docker Compose and build a self-trusting application container that connects to the Cosmos DB emulator.

## Project Structure

```
azure-container-apps/
├── .devcontainer/
│   └── devcontainer.json
├── .vscode/
│   └── settings.json
├── app/
│   ├── main.py          # Flask API
│   ├── Dockerfile       # Self-trusting App container
│   └── requirements.txt # Python dependencies
├── certificates/        # Autogenerated by emulator healthcheck
├── docker-compose.yml   # Infrastructure (Cosmos DB + Dev)
├── .env                 # Environment variables
├── main.py              # Test client script
├── pyproject.toml       # Project metadata
└── README.md
```

## Prerequisites

- Docker and Docker Compose installed
- VS Code with Dev Containers extension (optional, for dev container setup)

## Option 1: Using Dev Container (Recommended)

### Step 1: Open Project in Dev Container

1. Open VS Code in the project folder
2. Press `F1` or `Ctrl+Shift+P` (Windows/Linux) / `Cmd+Shift+P` (Mac)
3. Type and select: **Dev Containers: Reopen in Container**
4. Wait for the container to build and dependencies to install

### Step 2: Start Infrastructure and Build App

1. Start the Cosmos DB Emulator:
   ```bash
   docker compose up -d cosmos-emulator
   ```
2. Wait until the emulator is healthy (check with `docker ps`).
3. Build the application image:
   ```bash
   docker build -t aca-api -f app/Dockerfile .
   ```
4. Run the application container (using `--network host` for easy connectivity on Linux):
   ```bash
   docker run -d --name aca_app --network host aca-api
   ```

### Step 3: Run the Example

```bash
python main.py
```

You should see output like:

```
Sending request to http://localhost:8080/user...
Status Code: 201
Response: {
  "status": "success",
  "message": "Saved to CosmosDB"
}
```

## Option 2: Local Setup (Without Dev Container)

### Step 1: Install Python Dependencies

```bash
   curl -LsSf https://astral.sh/uv/install.sh | sh
   source $HOME/.local/bin/env
   uv sync
```

### Step 2: Start Infrastructure

1. Start Cosmos DB:
   ```bash
   docker compose up -d cosmos-emulator
   ```
2. Wait until the emulator is healthy (check with `docker ps`).

### Step 3: Install Emulator Certificate

To allow your local host to trust the emulator's self-signed certificate, follow these steps:

1. Download the certificate:
   ```bash
   curl --insecure https://localhost:8081/_explorer/emulator.pem > ~/emulatorcert.crt
   ```
2. Copy it to the trusted certificates folder:
   ```bash
   sudo cp ~/emulatorcert.crt /usr/local/share/ca-certificates/
   ```
3. Update the system trust store:
   ```bash
   sudo update-ca-certificates
   ```

### Step 4: Build and Run the App

1. Build the app (ensure you are in the project root):
   ```bash
   docker build -t aca-api -f app/Dockerfile .
   ```
2. Run the app:
   ```bash
   docker run -d --name aca_app --network host aca-api
   ```

### Step 5: Run the Example

```bash
python main.py
```

## Project Components

### Flask API (`app/main.py`)

Microservice that receives user data and saves it to Cosmos DB:

- **CosmosClient**: Connects to the emulator using environment variables.
- **`save_user()`**: Endpoint `/user` (POST) that upserts data into the "users" container.

### Main Script (`main.py`)

Test client that demonstrates the integration:

- Step 1: Defines a JSON payload with user information.
- Step 2: Sends a POST request to the Flask API.
- Step 3: Prints the response status and content.

## Environment Variables

The `.env` file contains:

```
COSMOS_ENDPOINT=https://localhost:8081
COSMOS_KEY=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==
```

**Note**: The key is the default master key for the Cosmos DB emulator.

## Useful Commands

### Docker Commands

```bash
# Start infrastructure
docker compose up -d cosmos-emulator

# Stop everything
docker compose down -v
docker stop aca_app && docker rm aca_app

# View app logs
docker logs aca_app
```

## Troubleshooting

### Building the App too early

If the `docker build` fails at the `COPY` step, make sure the `certificates/emulator.crt` file exists. It is only created after the `cosmos-emulator` has completed its first healthcheck.

### Connection Refused

Make sure both the emulator and the app are running:
```bash
docker ps
```

### Evaluation period has expired / PAL initialization failed

If you see `Error: The evaluation period has expired` or `PAL initialization failed. Error: 104`, it means the emulator image's 180-day evaluation period has ended. 

**Official Fix (Pull latest image):**
1.  Stop everything: `docker compose down -v`
2.  Remove the old image: `docker rmi mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator`
3.  Pull the latest: `docker pull mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:latest`
4.  Start again: `docker compose up -d cosmos-emulator`

**Workaround (Use a specific tag):**
If Microsoft hasn't updated the `latest` image and the official fix doesn't work, the most reliable solution is to find a specific and recent version tag from the official repository:
1. Go to [Azure Cosmos DB Emulator Docker Releases](https://github.com/Azure/azure-cosmos-db-emulator-docker/releases).
2. Look for the most recent tag (e.g., `vnext-EN20251223`).
3. Update the image in `docker-compose.patch.yml` with that tag.
4. Start using the patch file:
   ```bash
   docker compose -f docker-compose.patch.yml up -d
   ```

## Clean Up

To completely remove everything:

```bash
docker stop aca_app && docker rm aca_app
docker compose down -v
docker rmi aca-api
```

## License

This is a minimal example for educational purposes. Feel free to use and modify as needed.
